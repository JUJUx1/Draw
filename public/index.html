<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Roblox Draw Uploader</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Segoe UI',sans-serif;background:#0d0d1a;color:#e0e0e0;min-height:100vh;padding:20px 14px}
    h1{font-size:1.4rem;color:#a78bfa;margin-bottom:3px}
    .subtitle{font-size:.8rem;color:#555;margin-bottom:20px}

    /* Config banner */
    .config-banner{border-radius:10px;padding:14px 16px;margin-bottom:20px;font-size:.83rem;display:none}
    .config-banner.ok{background:#0a2010;border:1px solid #1a5c30;color:#4ade80}
    .config-banner.err{background:#200a0a;border:1px solid #5c1a1a;color:#f87171}
    .config-banner.loading{background:#0a0a20;border:1px solid #252550;color:#888}
    .config-banner strong{display:block;margin-bottom:4px;font-size:.9rem}
    .config-banner ul{margin-top:6px;padding-left:18px}
    .config-banner li{margin:3px 0}
    .config-step{margin-top:10px;background:#2a0a0a;border-radius:6px;padding:10px 12px;font-size:.78rem;color:#fca5a5;line-height:1.7}
    .config-step code{background:#3a1010;border-radius:3px;padding:1px 5px;font-family:monospace}

    /* Layout */
    .layout{display:grid;grid-template-columns:1fr 1fr;gap:18px;max-width:900px;margin:0 auto}
    @media(max-width:650px){.layout{grid-template-columns:1fr}}

    .panel{background:#13132a;border:1px solid #252545;border-radius:12px;padding:20px}
    .panel h2{font-size:.95rem;color:#c4b5fd;margin-bottom:14px;display:flex;align-items:center;gap:6px}

    /* Drop zone */
    .drop-zone{border:2px dashed #2e2e55;border-radius:10px;padding:28px 14px;text-align:center;cursor:pointer;transition:.2s}
    .drop-zone:hover,.drop-zone.over{border-color:#a78bfa;background:#1a1a3a}
    .drop-zone .icon{font-size:2.2rem;margin-bottom:7px}
    .drop-zone p{color:#666;font-size:.82rem}
    .drop-zone span{color:#a78bfa;font-weight:600}
    input[type=file]{display:none}

    /* Preview */
    .preview{display:none;align-items:center;gap:10px;margin-top:12px;background:#0d0d22;border-radius:8px;padding:10px}
    .preview img{width:54px;height:54px;object-fit:cover;border-radius:6px;border:1px solid #333;image-rendering:pixelated}
    .file-name{font-size:.82rem;color:#ccc;word-break:break-all}
    .file-size{font-size:.7rem;color:#555;margin-top:2px}

    /* Buttons */
    .btn{width:100%;margin-top:12px;padding:11px;border:none;border-radius:8px;font-size:.92rem;font-weight:700;cursor:pointer;transition:.15s}
    .btn:disabled{opacity:.35;cursor:not-allowed}
    .btn-primary{background:linear-gradient(135deg,#a78bfa,#7c3aed);color:#fff}
    .btn-primary:hover:not(:disabled){opacity:.88}
    .btn-sm{width:auto;padding:5px 12px;font-size:.76rem;font-weight:600;border-radius:6px;border:none;cursor:pointer}
    .btn-use{background:#1e3a5f;color:#60a5fa}
    .btn-use:hover{background:#1a4a7a}
    .btn-del{background:#3a1a1a;color:#f87171}
    .btn-del:hover{background:#5a1a1a}

    /* Progress */
    .progress-wrap{display:none;margin-top:12px}
    .progress-bg{background:#0a0a1a;border-radius:99px;height:7px;overflow:hidden}
    .progress-bar{height:100%;background:linear-gradient(90deg,#a78bfa,#7c3aed);border-radius:99px;width:0;transition:width .3s}
    .progress-label{font-size:.73rem;color:#777;text-align:center;margin-top:5px}

    /* Result */
    .result{display:none;margin-top:12px;border-radius:8px;padding:12px;font-size:.82rem;line-height:1.5}
    .result.ok{background:#0a2010;border:1px solid #1a5c30;color:#4ade80}
    .result.err{background:#200a0a;border:1px solid #5c1a1a;color:#f87171}
    .url-box{margin-top:8px;background:#061209;border-radius:5px;padding:7px 10px;font-family:monospace;font-size:.73rem;color:#86efac;word-break:break-all}
    .copy-btn{display:inline-block;margin-top:5px;padding:3px 9px;border-radius:5px;background:#1a5c30;color:#4ade80;border:none;cursor:pointer;font-size:.7rem}

    /* Gallery */
    .gallery-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:8px;margin-top:4px}
    .gallery-empty{color:#444;font-size:.82rem;text-align:center;padding:22px 0}
    .gallery-card{background:#0d0d22;border:1px solid #252545;border-radius:8px;overflow:hidden;transition:.15s}
    .gallery-card:hover{border-color:#4a4a7a}
    .gallery-card img{width:100%;aspect-ratio:1;object-fit:cover;display:block;image-rendering:pixelated}
    .gallery-card-body{padding:5px 7px}
    .gallery-card-name{font-size:.66rem;color:#aaa;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-bottom:4px}
    .gallery-card-actions{display:flex;gap:4px}
    .gallery-card.active{border-color:#a78bfa;box-shadow:0 0 0 2px #7c3aed55}
    .active-badge{font-size:.6rem;background:#7c3aed;color:#fff;border-radius:4px;padding:1px 5px;display:inline-block;margin-bottom:3px}
    .loading-spin{text-align:center;color:#555;font-size:.82rem;padding:18px 0}
  </style>
</head>
<body>

  <div style="max-width:900px;margin:0 auto 16px">
    <h1>ğŸ¨ Roblox Draw Uploader</h1>
    <p class="subtitle">Upload images â†’ converts to pixel JSON â†’ saves to GitHub â†’ Roblox draws it</p>

    <!-- Config status banner (shown on load) -->
    <div class="config-banner loading" id="configBanner" style="display:block">
      â³ Checking server configurationâ€¦
    </div>
  </div>

  <div class="layout">

    <!-- LEFT: Upload -->
    <div class="panel">
      <h2>ğŸ“¤ Upload New Image</h2>

      <div class="drop-zone" id="dropZone">
        <div class="icon">ğŸ–¼ï¸</div>
        <p>Drag & drop an image or <span>click to browse</span></p>
        <p style="margin-top:4px;font-size:.71rem">PNG Â· JPG Â· GIF Â· WEBP â€” max 10MB</p>
      </div>
      <input type="file" id="fileInput" accept="image/*"/>

      <div class="preview" id="preview">
        <img id="previewImg" src="" alt=""/>
        <div>
          <div class="file-name" id="fileName"></div>
          <div class="file-size" id="fileSize"></div>
        </div>
      </div>

      <button class="btn btn-primary" id="uploadBtn" disabled>Upload & Convert</button>

      <div class="progress-wrap" id="progressWrap">
        <div class="progress-bg"><div class="progress-bar" id="progressBar"></div></div>
        <div class="progress-label" id="progressLabel">Processing...</div>
      </div>

      <div class="result" id="uploadResult"></div>
    </div>

    <!-- RIGHT: Gallery -->
    <div class="panel">
      <h2>ğŸ—‚ï¸ Saved Images
        <span style="font-size:.72rem;color:#555;font-weight:400">(images/ folder)</span>
        <button class="btn-sm btn-use" id="refreshBtn" style="margin-left:auto">â†» Refresh</button>
      </h2>
      <div id="galleryWrap"><div class="loading-spin">Loading galleryâ€¦</div></div>
      <div class="result" id="galleryResult"></div>
    </div>

  </div>

  <script>
    const $ = id => document.getElementById(id);
    const fmt = b => b < 1024 ? b+'B' : b < 1048576 ? (b/1024).toFixed(1)+'KB' : (b/1048576).toFixed(1)+'MB';
    let selectedFile = null;
    let activeFilename = null;
    let serverOk = false;

    function showResult(el, ok, html) {
      el.className = 'result ' + (ok ? 'ok' : 'err');
      el.innerHTML = html;
      el.style.display = 'block';
    }

    // â”€â”€ Config check on load â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function checkConfig() {
      const banner = $('configBanner');
      try {
        const res = await fetch('/config-check');
        const data = await res.json();
        if (data.ok) {
          serverOk = true;
          banner.className = 'config-banner ok';
          banner.innerHTML = `
            <strong>âœ… Server connected to GitHub</strong>
            Repo: <code style="background:#0a3020;padding:1px 5px;border-radius:3px">${data.repo}</code>
            &nbsp;|&nbsp; Canvas: ${data.canvasSize}Ã—${data.canvasSize}
            &nbsp;|&nbsp; Branch: ${data.branch}
            <div style="margin-top:6px;font-size:.76rem;color:#86efac">
              drawing.json URL (paste in Lua script):<br/>
              <span id="rawUrl" style="font-family:monospace;word-break:break-all">${data.drawingUrl}</span>
              <button class="copy-btn" style="margin-left:6px"
                onclick="navigator.clipboard.writeText('${data.drawingUrl}');this.textContent='âœ“ Copied!'">
                ğŸ“‹ Copy
              </button>
            </div>`;
        } else {
          serverOk = false;
          banner.className = 'config-banner err';
          banner.innerHTML = `
            <strong>âš ï¸ Server not configured â€” fix this first!</strong>
            <ul>${(data.issues || []).map(i => `<li>${i}</li>`).join('')}</ul>
            <div class="config-step">
              <strong>How to fix:</strong><br/>
              1. Go to <a href="https://dashboard.render.com" target="_blank" style="color:#fca5a5">dashboard.render.com</a><br/>
              2. Click your service â†’ <strong>Environment</strong> tab<br/>
              3. Add these variables:<br/>
              &nbsp;&nbsp;<code>GITHUB_TOKEN</code> = your token from github.com/settings/tokens<br/>
              &nbsp;&nbsp;<code>GITHUB_REPO</code> = <code>yourusername/yourreponame</code><br/>
              &nbsp;&nbsp;<code>CANVAS_SIZE</code> = <code>64</code><br/>
              4. Click <strong>Save Changes</strong> â†’ service will redeploy automatically
            </div>`;
          $('uploadBtn').disabled = true;
        }
      } catch {
        banner.className = 'config-banner err';
        banner.innerHTML = '<strong>âŒ Cannot reach server</strong> â€” is it deployed on Render?';
      }
    }

    // â”€â”€ File selection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function setFile(file) {
      if (!file || !file.type.startsWith('image/')) return;
      selectedFile = file;
      $('fileName').textContent = file.name;
      $('fileSize').textContent = fmt(file.size);
      const reader = new FileReader();
      reader.onload = e => $('previewImg').src = e.target.result;
      reader.readAsDataURL(file);
      $('preview').style.display = 'flex';
      $('uploadBtn').disabled = !serverOk;
      $('uploadResult').style.display = 'none';
    }

    $('dropZone').addEventListener('click', () => $('fileInput').click());
    $('fileInput').addEventListener('change', e => setFile(e.target.files[0]));
    $('dropZone').addEventListener('dragover', e => { e.preventDefault(); $('dropZone').classList.add('over'); });
    $('dropZone').addEventListener('dragleave', () => $('dropZone').classList.remove('over'));
    $('dropZone').addEventListener('drop', e => { e.preventDefault(); $('dropZone').classList.remove('over'); setFile(e.dataTransfer.files[0]); });

    // â”€â”€ Upload â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    $('uploadBtn').addEventListener('click', async () => {
      if (!selectedFile) return;
      $('uploadBtn').disabled = true;
      $('progressWrap').style.display = 'block';
      $('uploadResult').style.display = 'none';

      let pct = 0;
      const tick = setInterval(() => {
        pct = Math.min(pct + Math.random() * 18, 88);
        $('progressBar').style.width = pct + '%';
        $('progressLabel').textContent = pct < 30 ? 'Uploadingâ€¦' : pct < 60 ? 'Converting pixelsâ€¦' : 'Saving to GitHubâ€¦';
      }, 300);

      try {
        const fd = new FormData();
        fd.append('image', selectedFile);
        const res = await fetch('/upload', { method: 'POST', body: fd });
        const data = await res.json();

        clearInterval(tick);
        $('progressBar').style.width = '100%';
        $('progressLabel').textContent = 'Done!';

        if (data.success) {
          activeFilename = data.image.filename;
          showResult($('uploadResult'), true, `
            âœ… <strong>Upload successful!</strong><br/>
            ${data.totalPixels.toLocaleString()} pixels Â· ${data.canvasSize}Ã—${data.canvasSize}<br/>
            Saved to: <code style="font-size:.72rem">${data.image.path}</code>
            <div class="url-box">${data.drawingUrl}</div>
            <button class="copy-btn" onclick="navigator.clipboard.writeText('${data.drawingUrl}');this.textContent='âœ“ Copied!'">ğŸ“‹ Copy drawing.json URL</button>
          `);
          loadGallery();
        } else {
          // Show detailed error with fix instructions
          let errHtml = `âŒ <strong>${data.error || 'Upload failed'}</strong>`;
          if (data.fix) errHtml += `<br/><span style="font-size:.78rem;color:#fca5a5">${data.fix}</span>`;
          showResult($('uploadResult'), false, errHtml);
        }
      } catch (err) {
        clearInterval(tick);
        showResult($('uploadResult'), false, `âŒ Network error: ${err.message}`);
      }

      setTimeout(() => {
        $('progressWrap').style.display = 'none';
        $('progressBar').style.width = '0';
        $('uploadBtn').disabled = false;
      }, 1500);
    });

    // â”€â”€ Gallery â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function loadGallery() {
      $('galleryWrap').innerHTML = '<div class="loading-spin">Loadingâ€¦</div>';
      try {
        const res = await fetch('/images');
        const data = await res.json();
        renderGallery(data.images || []);
      } catch {
        $('galleryWrap').innerHTML = '<div class="gallery-empty">Failed to load gallery</div>';
      }
    }

    function renderGallery(images) {
      if (!images.length) {
        $('galleryWrap').innerHTML = '<div class="gallery-empty">No saved images yet.<br/>Upload one to get started!</div>';
        return;
      }
      const grid = document.createElement('div');
      grid.className = 'gallery-grid';
      images.forEach(img => {
        const isActive = img.name === activeFilename;
        const card = document.createElement('div');
        card.className = 'gallery-card' + (isActive ? ' active' : '');
        card.innerHTML = `
          <img src="${img.rawUrl}" alt="${img.name}" loading="lazy"
               onerror="this.style.display='none'"/>
          <div class="gallery-card-body">
            ${isActive ? '<div class="active-badge">â–¶ Active</div>' : ''}
            <div class="gallery-card-name" title="${img.name}">${img.name}</div>
            <div class="gallery-card-actions">
              <button class="btn-sm btn-use" onclick="useImage('${img.rawUrl}','${img.name}')">â–¶</button>
              <button class="btn-sm btn-del" onclick="deleteImage('${img.name}',this)">ğŸ—‘</button>
            </div>
          </div>`;
        grid.appendChild(card);
      });
      $('galleryWrap').innerHTML = '';
      $('galleryWrap').appendChild(grid);
    }

    async function useImage(rawUrl, filename) {
      $('galleryResult').style.display = 'none';
      try {
        const res = await fetch('/use-image', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ rawUrl, filename }),
        });
        const data = await res.json();
        if (data.success) {
          activeFilename = filename;
          loadGallery();
          showResult($('galleryResult'), true, `
            âœ… <strong>${filename}</strong> is now active!<br/>
            ${data.totalPixels.toLocaleString()} pixels
            <div class="url-box">${data.drawingUrl}</div>
            <button class="copy-btn" onclick="navigator.clipboard.writeText('${data.drawingUrl}');this.textContent='âœ“ Copied!'">ğŸ“‹ Copy URL</button>
          `);
        } else throw new Error(data.error);
      } catch (err) {
        showResult($('galleryResult'), false, `âŒ ${err.message}`);
      }
    }

    async function deleteImage(filename, btn) {
      if (!confirm(`Delete "${filename}" from GitHub?`)) return;
      btn.disabled = true; btn.textContent = 'â€¦';
      try {
        const res = await fetch(`/images/${encodeURIComponent(filename)}`, { method: 'DELETE' });
        const data = await res.json();
        if (data.success) {
          if (activeFilename === filename) activeFilename = null;
          loadGallery();
        } else throw new Error(data.error);
      } catch (err) {
        showResult($('galleryResult'), false, `âŒ ${err.message}`);
        btn.disabled = false; btn.textContent = 'ğŸ—‘';
      }
    }

    $('refreshBtn').addEventListener('click', loadGallery);

    // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    checkConfig();
    loadGallery();
  </script>
</body>
</html>
